<!doctype html>
<meta charset="utf-8">
<title>빌링키 발급 완료</title>
<h2>빌링키 발급 완료</h2>

<label>별명(alias): <input id="alias" value="내 카드"></label>
<label style="margin-left:12px">
    <input type="checkbox" id="isDefault" checked> 기본 결제수단으로 설정
</label>
<pre id="out" style="background:#111;color:#c8f;padding:12px;border-radius:8px;white-space:pre-wrap"></pre>
<button id="goWallet" style="display:none">지갑 충전하러 가기</button>

<script>
    const log = (msg) =>
      (document.getElementById('out').textContent += msg + '\n');

    (async () => {
      const qs = new URLSearchParams(location.search);
      const authKey = qs.get('authKey'); // Toss가 successUrl로 넘겨준 값
      if (!authKey) { log('authKey가 없습니다. 직접 접근하신 것 같아요.'); return; }

      try {
        log('1) 서버에 authKey 교환 요청 중...');
        // 1) authKey -> billingKey 교환 (쿠키 인증)
        const r1 = await fetch('/api/v1/payments/toss/issue-billing-key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ authKey })
        });
        const res1 = await r1.json();
        if (!r1.ok) throw new Error(`교환 실패: ${r1.status} ${res1.msg || ''}`);

        const d = res1.data || res1; // RsData 대응
        const billingKey = d.billingKey;
        log(`✓ 교환 성공 → billingKey=${billingKey}`);

        // 카드 정보(있으면) 보조로 사용
        const brand   = d.brand ?? d.cardBrand ?? null;
        const rawLast4 = d.last4 ?? d.cardNumber ?? null;
        const last4   = rawLast4
            ? String(rawLast4).replace(/\D/g, '').slice(-4)  // 숫자만 남기고 끝 4자리
            : null;
        const expMon  = d.expMonth ?? null;
        const expYear = d.expYear  ?? null;

        // 2) 결제수단 저장 (서버 DTO에 맞춰 token/brand/provide 사용)
        log('2) 결제수단 저장 중...');
        const alias = document.getElementById('alias').value || '내 카드';
        const isDefault = document.getElementById('isDefault').checked;

        const r2 = await fetch('/api/v1/paymentMethods', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            provider: 'toss',        // ★ 서버가 기대하는 값
            type: 'CARD',
            alias: alias,
            isDefault: isDefault,
            token: billingKey,       // ★ billingKey를 token으로 저장
            brand: brand,            // ★ cardBrand → brand
            last4: last4,
            expMonth: expMon,
            expYear: expYear
          })
        });
        const res2 = await r2.json();
        if (!r2.ok) throw new Error(`저장 실패: ${r2.status} ${res2.msg || ''}`);

        log('✓ 결제수단 저장 완료');

        // 다음 화면 이동 버튼 노출(원하는 곳으로 이동)
        const btn = document.getElementById('goWallet');
        btn.style.display = 'inline-block';
        btn.onclick = () => location.href = '/swagger-ui/index.html#/Payments/charge';
      } catch (e) {
        log('에러: ' + e.message);
        console.error(e);
      }
    })();
</script>
