<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>실시간 경매 테스트 (개인 알림 강화)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .bid-section { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 5px; }
        .current-bid { background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .bid-form { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .bid-history {
            background: #fff; border: 1px solid #eee; padding: 10px;
            height: 300px;
            overflow-y: auto;
        }
        .bid-item { padding: 5px 0; border-bottom: 1px solid #eee; }
        .bid-item:last-child { border-bottom: none; }
        .item-broadcast { color: #0056b3; } /* 실시간 브로드캐스트 (전체) */
        .item-personal { color: #8b0000; font-weight: bold; background-color: #ffe0e0; padding: 2px 5px; border-radius: 3px; }
        input, button, select { padding: 8px 12px; margin: 5px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 5px 10px; margin: 5px; border-radius: 3px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<div class="container">
    <h1>🔥 실시간 경매 테스트</h1>

    <div class="bid-section">
        <h3>1️⃣ 로그인</h3>
        <select id="userSelect" style="width: 400px;">
            <option value="">계정 선택...</option>
            <option value="user1@example.com">user1 (전자기기왕) - 잔액: 500,000원</option>
            <option value="user2@example.com">user2 (패션러버) - 잔액: 1,000,000원</option>
            <option value="user3@example.com">user3 (스포츠매니아) - 잔액: 200,000원</option>
            <option value="user4@example.com">user4 (책벌레) - 잔액: 500,000원</option>
            <option value="user5@example.com">user5 (명품수집가) - 잔액: 1,000,000원</option>
        </select>
        <button id="loginBtn">로그인</button>
        <p id="loginStatus" style="color: #666; margin: 5px;"></p>
    </div>

    <div class="bid-section">
        <h3>2️⃣ WebSocket 연결</h3>
        <span id="status" class="status disconnected">연결 안됨</span>
        <button id="connect" disabled>연결</button>
        <button id="disconnect" disabled>연결 해제</button>
        <p><small>📢 로그인 후 WebSocket 연결이 가능합니다!</small></p>
    </div>

    <div class="bid-section">
        <h3>3️⃣ 테스트할 상품 선택</h3>
        <input type="number" id="productId" placeholder="상품 ID" value="1">
        <button id="subscribe" disabled>이 상품 입찰 정보 및 개인 알림 구독</button>
        <p>현재 구독 중: <span id="currentProduct">없음</span></p>
    </div>

    <div class="current-bid">
        <h3>💰 현재 최고 입찰 (전체 브로드캐스트)</h3>
        <div id="currentBidInfo">
            <p>최고가: <strong id="highestBid">-</strong>원</p>
            <p>입찰자: <span id="bidder">-</span></p>
            <p>시간: <span id="bidTime">-</span></p>
        </div>
    </div>

    <div class="bid-form">
        <h3>🎯 입찰하기 (개인 알림 테스트)</h3>
        <input type="number" id="bidAmount" placeholder="입찰 금액" step="10000" disabled>
        <button id="placeBid" disabled>입찰하기</button>
        <p><small>※ 입찰 시, 전체 브로드캐스트 및 **나에게만 오는 개인 알림**을 확인하세요.</small></p>
    </div>

    <div class="bid-section">
        <h3>📊 실시간 내역 (브로드캐스트 & 개인 알림)</h3>
        <div id="bidHistory" class="bid-history">
            <p>내역이 여기에 실시간으로 표시됩니다...</p>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentProductId = null;
    let bidSubscription = null;
    let notiSubscription = null;
    let jwtToken = null;

    // 로그인 처리
    async function login() {
        const email = document.getElementById('userSelect').value;
        if (!email) {
            alert('계정을 선택해주세요!');
            return;
        }

        document.getElementById('loginStatus').textContent = '로그인 중...';
        
        try {
            const response = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: 'password123'
                })
            });

            if (response.ok) {
                const data = await response.json();
                jwtToken = data.data.accessToken;
                
                document.getElementById('loginStatus').textContent = '✅ 로그인 성공! ' + email;
                document.getElementById('loginStatus').style.color = '#155724';
                document.getElementById('connect').disabled = false;
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('userSelect').disabled = true;
                
                addBidHistory('✅ 로그인 성공: ' + email, 'broadcast');
            } else {
                const error = await response.json();
                document.getElementById('loginStatus').textContent = '❌ 로그인 실패: ' + error.msg;
                document.getElementById('loginStatus').style.color = '#721c24';
            }
        } catch (error) {
            console.error('Login error:', error);
            document.getElementById('loginStatus').textContent = '❌ 로그인 오류: ' + error.message;
            document.getElementById('loginStatus').style.color = '#721c24';
        }
    }

    // WebSocket 연결
    function connect() {
        if (stompClient && stompClient.connected) return;
        if (!jwtToken) {
            alert('먼저 로그인해주세요!');
            return;
        }

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        // JWT 토큰과 함께 연결
        stompClient.connect({
            'Authorization': 'Bearer ' + jwtToken
        }, function(frame) {
            console.log('Connected: ' + frame);
            document.getElementById('status').textContent = '연결됨';
            document.getElementById('status').className = 'status connected';
            document.getElementById('disconnect').disabled = false;
            document.getElementById('subscribe').disabled = false;
            addBidHistory('✅ WebSocket 연결 성공!', 'broadcast');

            subscribeToNotifications();

        }, function(error) {
            console.log('Connection error: ' + error);
            document.getElementById('status').textContent = '연결 실패';
            document.getElementById('status').className = 'status disconnected';
            addBidHistory('❌ WebSocket 연결 실패: ' + error, 'broadcast');
        });
    }

    // WebSocket 연결 해제
    function disconnect() {
        if (stompClient !== null) {
            if (bidSubscription) {
                bidSubscription.unsubscribe();
                bidSubscription = null;
            }
            if (notiSubscription) {
                notiSubscription.unsubscribe();
                notiSubscription = null;
            }
            stompClient.disconnect();
            stompClient = null;

            document.getElementById('status').textContent = '연결 해제됨';
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('currentProduct').textContent = '없음';
            document.getElementById('disconnect').disabled = true;
            document.getElementById('subscribe').disabled = true;
            document.getElementById('bidAmount').disabled = true;
            document.getElementById('placeBid').disabled = true;
            addBidHistory('🔌 WebSocket 연결 해제', 'broadcast');
        }
    }

    // 개인 알림 채널 구독
    function subscribeToNotifications() {
        if (notiSubscription) {
            notiSubscription.unsubscribe();
        }

        // '/user/queue/notifications' 구독
        notiSubscription = stompClient.subscribe('/user/queue/notifications', function(message) {
            console.log('=== 개인 알림 수신 ===');
            console.log('Notification message:', message.body);

            try {
                const notification = JSON.parse(message.body);
                handlePersonalNotification(notification);
            } catch (error) {
                console.error('알림 파싱 에러:', error);
                addBidHistory('❌ 개인 알림 파싱 실패: ' + message.body, 'personal');
            }
        });
        addBidHistory('🔔 개인 알림 채널 구독 성공!', 'personal');
    }

    // 상품 구독 (브로드캐스트 채널)
    function subscribeToProduct() {
        const productId = document.getElementById('productId').value;
        if (!productId || !stompClient || !stompClient.connected) {
            alert('상품 ID를 입력하고 WebSocket에 연결해주세요.');
            return;
        }

        if (bidSubscription) {
            bidSubscription.unsubscribe();
        }

        bidSubscription = stompClient.subscribe('/topic/bid/' + productId, function(message) {
            console.log('=== 브로드캐스트 메시지 수신 ===');
            console.log('Message body:', message.body);

            try {
                const bidData = JSON.parse(message.body);
                handleBroadcastMessage(bidData);
            } catch (error) {
                console.error('JSON 파싱 에러:', error);
                addBidHistory('❌ 메시지 파싱 실패: ' + message.body, 'broadcast');
            }
        });

        currentProductId = productId;
        document.getElementById('currentProduct').textContent = '상품 ' + productId;
        document.getElementById('bidAmount').disabled = false;
        document.getElementById('placeBid').disabled = false;
        addBidHistory('📡 상품 ' + productId + ' 입찰 정보 구독 시작', 'broadcast');
    }

    // 브로드캐스트 메시지 처리 로직
    function handleBroadcastMessage(bidData) {

        if (bidData.type === 'BID') {
            // 입찰 업데이트 브로드캐스트
            updateCurrentBid(bidData.data);
            addBidHistory('🚀 새 입찰: ' + bidData.data.price.toLocaleString() + '원 (상품 ' + bidData.data.productId + ')', 'broadcast');
        } else if (bidData.type === 'SYSTEM') {
            // 시스템 알림 (종료 임박, 종료 등) 브로드캐스트
            const content = bidData.content || "시스템 알림 도착";
            addBidHistory('📢 ' + content, 'broadcast');

            if (bidData.data && bidData.data.isSuccessful !== undefined) {
                // 경매 종료 알림 상세 (낙찰/유찰)
                if (bidData.data.isSuccessful) {
                    addBidHistory('🎉 낙찰! 최종 낙찰가: ' + bidData.data.finalPrice.toLocaleString() + '원', 'broadcast');
                } else {
                    addBidHistory('😔 유찰되었습니다.', 'broadcast');
                }
            }
        }
    }

    // 개인 알림 메시지 처리 로직 (Auction/BidNotificationService에서 오는 알림)
    function handlePersonalNotification(notification) {
        const content = notification.content;
        const data = notification.data;

        // 메인 알림 로그 출력
        addBidHistory(`🔔 ${content}`, 'personal');

        if (data && data.type) {
            let detailMessage = '';

            switch(data.type) {
                case 'AUCTION_START': // AuctionNotificationService
                    detailMessage = `▶️ 경매 시작! 시작가: ${data.initialPrice.toLocaleString()}원`;
                    break;
                case 'AUCTION_ENDING_SOON': // AuctionNotificationService
                    detailMessage = `⏳ 종료 임박! ${data.remainingMinutes}분 후 종료. 현재가: ${data.currentPrice.toLocaleString()}원`;
                    break;
                case 'AUCTION_END': // AuctionNotificationService
                    detailMessage = data.hasWinner ?
                        `🏆 경매 종료: 최종가 ${data.finalPrice.toLocaleString()}원` :
                        `💧 경매 종료: 유찰되었습니다.`;
                    break;
                case 'BID_SUCCESS': // BidNotificationService
                    detailMessage = `✅ 나의 입찰 성공: ${data.bidAmount.toLocaleString()}원 (최고가 유지)`;
                    break;
                case 'BID_OUTBID': // BidNotificationService
                    detailMessage = `😔 입찰 밀림! 새로운 최고가: ${data.newHighestBid.toLocaleString()}원`;
                    break;
                case 'AUCTION_WON': // BidNotificationService
                    detailMessage = `🎉 **최종 낙찰 성공!** 금액: ${data.finalPrice.toLocaleString()}원`;
                    break;
                case 'AUCTION_LOST': // BidNotificationService
                    detailMessage = `😞 **낙찰 실패**. 최종가: ${data.finalPrice.toLocaleString()}원`;
                    break;
                default:
                    detailMessage = `⚠️ 알 수 없는 알림 타입: ${data.type}`;
                    break;
            }

            if (detailMessage) {
                // 상세 정보는 같은 유형으로 한번 더 출력하여 강조
                addBidHistory(detailMessage, 'personal');
            }
        }
    }

    // REST API로 입찰하기
    async function placeBid() {
        const productId = document.getElementById('productId').value;
        const bidAmount = document.getElementById('bidAmount').value;

        if (!productId || !bidAmount) {
            alert('상품 ID와 입찰 금액을 입력해주세요.');
            return;
        }

        if (!jwtToken) {
            alert('먼저 로그인해주세요!');
            return;
        }

        try {
            const response = await fetch('/api/v1/bids/products/' + productId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify({
                    price: parseInt(bidAmount)
                })
            });

            if (response.ok) {
                addBidHistory('✅ 입찰 요청 전송: ' + parseInt(bidAmount).toLocaleString() + '원', 'broadcast');
                document.getElementById('bidAmount').value = '';
            } else {
                const data = await response.json();
                addBidHistory('❌ 입찰 요청 실패: ' + (data.msg || data.message), 'broadcast');
            }
        } catch (error) {
            console.error('Error:', error);
            addBidHistory('❌ 입찰 요청 오류: ' + error.message, 'broadcast');
        }
    }

    // 현재 입찰 정보 업데이트
    function updateCurrentBid(bidData) {
        if (bidData && bidData.price) {
            document.getElementById('highestBid').textContent = bidData.price.toLocaleString();
            // 브로드캐스트 데이터에 bidderId가 포함되어 있다고 가정
            document.getElementById('bidder').textContent = 'User ' + (bidData.bidderId || '?');
            document.getElementById('bidTime').textContent = new Date(bidData.createDate).toLocaleTimeString();
        }
    }

    // 입찰 내역에 추가 (개인 알림과 전체 알림을 구분)
    function addBidHistory(message, type = 'broadcast') {
        const historyDiv = document.getElementById('bidHistory');
        const timestamp = new Date().toLocaleTimeString();
        const newItem = document.createElement('div');
        newItem.className = 'bid-item';

        let typeClass = '';
        if (type === 'personal') {
            typeClass = 'item-personal';
        } else if (type === 'broadcast') {
            typeClass = 'item-broadcast';
        }

        newItem.innerHTML = `<span class="${typeClass}">[${type === 'personal' ? '개인' : '전체'}]</span> <strong>${timestamp}</strong> - ${message}`;

        historyDiv.appendChild(newItem);
        historyDiv.scrollTop = historyDiv.scrollHeight;
    }

    // 이벤트 리스너
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('connect').addEventListener('click', connect);
    document.getElementById('disconnect').addEventListener('click', disconnect);
    document.getElementById('subscribe').addEventListener('click', subscribeToProduct);
    document.getElementById('placeBid').addEventListener('click', placeBid);

    // Enter 키로 입찰하기
    document.getElementById('bidAmount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            placeBid();
        }
    });

    // 페이지 로드시 안내
    addBidHistory('🎯 실시간 경매 테스트 페이지입니다.', 'broadcast');
    addBidHistory('1. 계정을 선택하고 "로그인" 버튼을 클릭하세요.', 'broadcast');
    addBidHistory('2. "연결" 버튼을 클릭하여 WebSocket을 연결하세요.', 'broadcast');
    addBidHistory('3. 상품 ID를 입력하고 "구독" 버튼을 클릭하세요.', 'broadcast');
    addBidHistory('4. 입찰 금액을 입력하고 "입찰하기" 버튼을 클릭하여 개인 알림을 확인하세요.', 'broadcast');
    addBidHistory('💡 창 2개를 열어서 다른 계정으로 테스트해보세요!', 'broadcast');
</script>
</body>
</html>