<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>실시간 입찰 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .bid-section { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 5px; }
        .current-bid { background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .bid-form { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .bid-history { background: #fff; border: 1px solid #eee; padding: 10px; height: 200px; overflow-y: auto; }
        .bid-item { padding: 5px 0; border-bottom: 1px solid #eee; }
        .bid-item:last-child { border-bottom: none; }
        input, button { padding: 8px 12px; margin: 5px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { padding: 5px 10px; margin: 5px; border-radius: 3px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 실시간 입찰 테스트</h1>
        
        <!-- 연결 상태 -->
        <div class="bid-section">
            <h3>WebSocket 연결</h3>
            <span id="status" class="status disconnected">연결 안됨</span>
            <button id="connect">연결</button>
            <button id="disconnect">연결 해제</button>
        </div>

        <!-- 상품 선택 -->
        <div class="bid-section">
            <h3>테스트할 상품 선택</h3>
            <input type="number" id="productId" placeholder="상품 ID" value="1">
            <button id="subscribe">이 상품 입찰 정보 구독</button>
            <p>현재 구독 중: <span id="currentProduct">없음</span></p>
        </div>

        <!-- 현재 입찰 정보 -->
        <div class="current-bid">
            <h3>💰 현재 최고 입찰</h3>
            <div id="currentBidInfo">
                <p>최고가: <strong id="highestBid">-</strong>원</p>
                <p>입찰자: <span id="bidder">-</span></p>
                <p>시간: <span id="bidTime">-</span></p>
            </div>
        </div>

        <!-- 입찰하기 -->
        <div class="bid-form">
            <h3>🎯 입찰하기</h3>
            <input type="number" id="bidAmount" placeholder="입찰 금액" step="100">
            <button id="placeBid">입찰하기</button>
            <p><small>※ REST API로 입찰 → WebSocket으로 실시간 브로드캐스트</small></p>
        </div>

        <!-- 실시간 입찰 내역 -->
        <div class="bid-section">
            <h3>📊 실시간 입찰 내역</h3>
            <div id="bidHistory" class="bid-history">
                <p>입찰 내역이 여기에 실시간으로 표시됩니다...</p>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentProductId = null;
        let currentSubscription = null;

        // WebSocket 연결
        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                document.getElementById('status').textContent = '연결됨';
                document.getElementById('status').className = 'status connected';
                addBidHistory('✅ WebSocket 연결 성공!');
            }, function(error) {
                console.log('Connection error: ' + error);
                document.getElementById('status').textContent = '연결 실패';
                document.getElementById('status').className = 'status disconnected';
                addBidHistory('❌ WebSocket 연결 실패: ' + error);
            });
        }

        // WebSocket 연결 해제
        function disconnect() {
            if (stompClient !== null) {
                if (currentSubscription) {
                    currentSubscription.unsubscribe();
                    currentSubscription = null;
                }
                stompClient.disconnect();
                document.getElementById('status').textContent = '연결 해제됨';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('currentProduct').textContent = '없음';
                addBidHistory('🔌 WebSocket 연결 해제');
            }
        }

        // 상품 구독
        function subscribeToProduct() {
            const productId = document.getElementById('productId').value;
            if (!productId || !stompClient) {
                alert('상품 ID를 입력하고 WebSocket에 연결해주세요.');
                return;
            }

            // 이전 구독 해제
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }

            // 새 구독 시작
            currentSubscription = stompClient.subscribe('/topic/bid/' + productId, function(message) {
                console.log('=== WebSocket 메시지 수신 ===');
                console.log('Raw message:', message);
                console.log('Message body:', message.body);
                
                try {
                    const bidData = JSON.parse(message.body);
                    console.log('Parsed bid data:', bidData);
                    
                    // 현재 입찰 정보 업데이트
                    if (bidData.type === 'BID') {
                        updateCurrentBid(bidData.data);
                        addBidHistory('🚀 새 입찰: ' + bidData.data.price.toLocaleString() + '원 (' + new Date().toLocaleTimeString() + ')');
                    } else if (bidData.type === 'SYSTEM') {
                        // 경매 종료 알림
                        addBidHistory('📢 ' + bidData.content + ' (' + new Date().toLocaleTimeString() + ')');
                        if (bidData.data && bidData.data.isSuccessful !== undefined) {
                            if (bidData.data.isSuccessful) {
                                addBidHistory('🎉 낙찰! 최종 낙찰가: ' + bidData.data.finalPrice.toLocaleString() + '원');
                            } else {
                                addBidHistory('😔 유찰되었습니다.');
                            }
                        }
                    }
                } catch (error) {
                    console.error('JSON 파싱 에러:', error);
                    console.log('원본 메시지:', message.body);
                    addBidHistory('❌ 메시지 파싱 실패: ' + message.body);
                }
            });

            // 개인 알림 구독
            stompClient.subscribe('/user/queue/notifications', function(message) {
                console.log('=== 개인 알림 수신 ===');
                console.log('Notification message:', message.body);
                
                try {
                    const notification = JSON.parse(message.body);
                    addBidHistory('🔔 개인 알림: ' + notification.content);
                    
                    if (notification.data && notification.data.type) {
                        switch(notification.data.type) {
                            case 'BID_SUCCESS':
                                addBidHistory('✅ 입찰 성공 알림이 도착했습니다!');
                                break;
                            case 'BID_OUTBID':
                                addBidHistory('😔 다른 입찰자에게 밀렸습니다');
                                break;
                            case 'AUCTION_WON':
                                addBidHistory('🎉 낙찰 축하합니다!');
                                break;
                            case 'AUCTION_LOST':
                                addBidHistory('😞 낙찰에 실패했습니다');
                                break;
                        }
                    }
                } catch (error) {
                    console.error('알림 파싱 에러:', error);
                }
            });

            currentProductId = productId;
            document.getElementById('currentProduct').textContent = '상품 ' + productId;
            addBidHistory('📡 상품 ' + productId + ' 구독 시작');
        }

        // REST API로 입찰하기
        function placeBid() {
            const productId = document.getElementById('productId').value;
            const bidAmount = document.getElementById('bidAmount').value;

            if (!productId || !bidAmount) {
                alert('상품 ID와 입찰 금액을 입력해주세요.');
                return;
            }

            // REST API 호출
            fetch('/api/v1/bids/products/' + productId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer test-token' // 임시 토큰
                },
                body: JSON.stringify({
                    price: parseInt(bidAmount)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.resultCode.startsWith('2')) {
                    addBidHistory('✅ 입찰 성공: ' + bidAmount + '원');
                    document.getElementById('bidAmount').value = '';
                } else {
                    addBidHistory('❌ 입찰 실패: ' + data.msg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addBidHistory('❌ 입찰 요청 오류: ' + error.message);
            });
        }

        // 현재 입찰 정보 업데이트
        function updateCurrentBid(bidData) {
            console.log('Updating UI with bid data:', bidData);
            if (bidData && bidData.price) {
                document.getElementById('highestBid').textContent = bidData.price.toLocaleString();
                document.getElementById('bidder').textContent = 'User ' + bidData.bidderId;
                document.getElementById('bidTime').textContent = new Date(bidData.createDate).toLocaleTimeString();
            } else {
                console.error('bidData.price가 없습니다:', bidData);
                addBidHistory('❌ 입찰 데이터 형식 오류');
            }
        }

        // 입찰 내역에 추가
        function addBidHistory(message) {
            const historyDiv = document.getElementById('bidHistory');
            const timestamp = new Date().toLocaleTimeString();
            const newItem = document.createElement('div');
            newItem.className = 'bid-item';
            newItem.innerHTML = '<strong>' + timestamp + '</strong> - ' + message;
            historyDiv.appendChild(newItem);
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        // 이벤트 리스너
        document.getElementById('connect').addEventListener('click', connect);
        document.getElementById('disconnect').addEventListener('click', disconnect);
        document.getElementById('subscribe').addEventListener('click', subscribeToProduct);
        document.getElementById('placeBid').addEventListener('click', placeBid);

        // Enter 키로 입찰하기
        document.getElementById('bidAmount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                placeBid();
            }
        });

        // 페이지 로드시 안내
        addBidHistory('🎯 실시간 입찰 테스트 페이지입니다.');
        addBidHistory('1. 먼저 "연결" 버튼을 클릭하세요.');
        addBidHistory('2. 상품 ID를 입력하고 "구독" 버튼을 클릭하세요.');
        addBidHistory('3. 입찰 금액을 입력하고 "입찰하기" 버튼을 클릭하세요.');
        addBidHistory('4. 다른 탭에서도 같은 상품을 구독하면 실시간 업데이트를 확인할 수 있습니다!');
    </script>
</body>
</html>
