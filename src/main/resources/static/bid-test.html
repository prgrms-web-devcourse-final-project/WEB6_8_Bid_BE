<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ì…ì°° í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .bid-section { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 5px; }
        .current-bid { background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .bid-form { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .bid-history { background: #fff; border: 1px solid #eee; padding: 10px; height: 200px; overflow-y: auto; }
        .bid-item { padding: 5px 0; border-bottom: 1px solid #eee; }
        .bid-item:last-child { border-bottom: none; }
        input, button { padding: 8px 12px; margin: 5px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { padding: 5px 10px; margin: 5px; border-radius: 3px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ ì‹¤ì‹œê°„ ì…ì°° í…ŒìŠ¤íŠ¸</h1>
        
        <!-- ì—°ê²° ìƒíƒœ -->
        <div class="bid-section">
            <h3>WebSocket ì—°ê²°</h3>
            <span id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</span>
            <button id="connect">ì—°ê²°</button>
            <button id="disconnect">ì—°ê²° í•´ì œ</button>
        </div>

        <!-- ìƒí’ˆ ì„ íƒ -->
        <div class="bid-section">
            <h3>í…ŒìŠ¤íŠ¸í•  ìƒí’ˆ ì„ íƒ</h3>
            <input type="number" id="productId" placeholder="ìƒí’ˆ ID" value="1">
            <button id="subscribe">ì´ ìƒí’ˆ ì…ì°° ì •ë³´ êµ¬ë…</button>
            <p>í˜„ì¬ êµ¬ë… ì¤‘: <span id="currentProduct">ì—†ìŒ</span></p>
        </div>

        <!-- í˜„ì¬ ì…ì°° ì •ë³´ -->
        <div class="current-bid">
            <h3>ğŸ’° í˜„ì¬ ìµœê³  ì…ì°°</h3>
            <div id="currentBidInfo">
                <p>ìµœê³ ê°€: <strong id="highestBid">-</strong>ì›</p>
                <p>ì…ì°°ì: <span id="bidder">-</span></p>
                <p>ì‹œê°„: <span id="bidTime">-</span></p>
            </div>
        </div>

        <!-- ì…ì°°í•˜ê¸° -->
        <div class="bid-form">
            <h3>ğŸ¯ ì…ì°°í•˜ê¸°</h3>
            <input type="number" id="bidAmount" placeholder="ì…ì°° ê¸ˆì•¡" step="100">
            <button id="placeBid">ì…ì°°í•˜ê¸°</button>
            <p><small>â€» REST APIë¡œ ì…ì°° â†’ WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ë¸Œë¡œë“œìºìŠ¤íŠ¸</small></p>
        </div>

        <!-- ì‹¤ì‹œê°„ ì…ì°° ë‚´ì—­ -->
        <div class="bid-section">
            <h3>ğŸ“Š ì‹¤ì‹œê°„ ì…ì°° ë‚´ì—­</h3>
            <div id="bidHistory" class="bid-history">
                <p>ì…ì°° ë‚´ì—­ì´ ì—¬ê¸°ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤...</p>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentProductId = null;
        let currentSubscription = null;

        // WebSocket ì—°ê²°
        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                document.getElementById('status').textContent = 'ì—°ê²°ë¨';
                document.getElementById('status').className = 'status connected';
                addBidHistory('âœ… WebSocket ì—°ê²° ì„±ê³µ!');
            }, function(error) {
                console.log('Connection error: ' + error);
                document.getElementById('status').textContent = 'ì—°ê²° ì‹¤íŒ¨';
                document.getElementById('status').className = 'status disconnected';
                addBidHistory('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error);
            });
        }

        // WebSocket ì—°ê²° í•´ì œ
        function disconnect() {
            if (stompClient !== null) {
                if (currentSubscription) {
                    currentSubscription.unsubscribe();
                    currentSubscription = null;
                }
                stompClient.disconnect();
                document.getElementById('status').textContent = 'ì—°ê²° í•´ì œë¨';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('currentProduct').textContent = 'ì—†ìŒ';
                addBidHistory('ğŸ”Œ WebSocket ì—°ê²° í•´ì œ');
            }
        }

        // ìƒí’ˆ êµ¬ë…
        function subscribeToProduct() {
            const productId = document.getElementById('productId').value;
            if (!productId || !stompClient) {
                alert('ìƒí’ˆ IDë¥¼ ì…ë ¥í•˜ê³  WebSocketì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì´ì „ êµ¬ë… í•´ì œ
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }

            // ìƒˆ êµ¬ë… ì‹œì‘
            currentSubscription = stompClient.subscribe('/topic/bid/' + productId, function(message) {
                console.log('=== WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ===');
                console.log('Raw message:', message);
                console.log('Message body:', message.body);
                
                try {
                    const bidData = JSON.parse(message.body);
                    console.log('Parsed bid data:', bidData);
                    
                    // í˜„ì¬ ì…ì°° ì •ë³´ ì—…ë°ì´íŠ¸
                    if (bidData.type === 'BID') {
                        updateCurrentBid(bidData.data);
                        addBidHistory('ğŸš€ ìƒˆ ì…ì°°: ' + bidData.data.price.toLocaleString() + 'ì› (' + new Date().toLocaleTimeString() + ')');
                    } else if (bidData.type === 'SYSTEM') {
                        // ê²½ë§¤ ì¢…ë£Œ ì•Œë¦¼
                        addBidHistory('ğŸ“¢ ' + bidData.content + ' (' + new Date().toLocaleTimeString() + ')');
                        if (bidData.data && bidData.data.isSuccessful !== undefined) {
                            if (bidData.data.isSuccessful) {
                                addBidHistory('ğŸ‰ ë‚™ì°°! ìµœì¢… ë‚™ì°°ê°€: ' + bidData.data.finalPrice.toLocaleString() + 'ì›');
                            } else {
                                addBidHistory('ğŸ˜” ìœ ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        }
                    }
                } catch (error) {
                    console.error('JSON íŒŒì‹± ì—ëŸ¬:', error);
                    console.log('ì›ë³¸ ë©”ì‹œì§€:', message.body);
                    addBidHistory('âŒ ë©”ì‹œì§€ íŒŒì‹± ì‹¤íŒ¨: ' + message.body);
                }
            });

            // ê°œì¸ ì•Œë¦¼ êµ¬ë…
            stompClient.subscribe('/user/queue/notifications', function(message) {
                console.log('=== ê°œì¸ ì•Œë¦¼ ìˆ˜ì‹  ===');
                console.log('Notification message:', message.body);
                
                try {
                    const notification = JSON.parse(message.body);
                    addBidHistory('ğŸ”” ê°œì¸ ì•Œë¦¼: ' + notification.content);
                    
                    if (notification.data && notification.data.type) {
                        switch(notification.data.type) {
                            case 'BID_SUCCESS':
                                addBidHistory('âœ… ì…ì°° ì„±ê³µ ì•Œë¦¼ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!');
                                break;
                            case 'BID_OUTBID':
                                addBidHistory('ğŸ˜” ë‹¤ë¥¸ ì…ì°°ìì—ê²Œ ë°€ë ¸ìŠµë‹ˆë‹¤');
                                break;
                            case 'AUCTION_WON':
                                addBidHistory('ğŸ‰ ë‚™ì°° ì¶•í•˜í•©ë‹ˆë‹¤!');
                                break;
                            case 'AUCTION_LOST':
                                addBidHistory('ğŸ˜ ë‚™ì°°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                                break;
                        }
                    }
                } catch (error) {
                    console.error('ì•Œë¦¼ íŒŒì‹± ì—ëŸ¬:', error);
                }
            });

            currentProductId = productId;
            document.getElementById('currentProduct').textContent = 'ìƒí’ˆ ' + productId;
            addBidHistory('ğŸ“¡ ìƒí’ˆ ' + productId + ' êµ¬ë… ì‹œì‘');
        }

        // REST APIë¡œ ì…ì°°í•˜ê¸°
        function placeBid() {
            const productId = document.getElementById('productId').value;
            const bidAmount = document.getElementById('bidAmount').value;

            if (!productId || !bidAmount) {
                alert('ìƒí’ˆ IDì™€ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // REST API í˜¸ì¶œ
            fetch('/api/v1/bids/products/' + productId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer test-token' // ì„ì‹œ í† í°
                },
                body: JSON.stringify({
                    price: parseInt(bidAmount)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.resultCode.startsWith('2')) {
                    addBidHistory('âœ… ì…ì°° ì„±ê³µ: ' + bidAmount + 'ì›');
                    document.getElementById('bidAmount').value = '';
                } else {
                    addBidHistory('âŒ ì…ì°° ì‹¤íŒ¨: ' + data.msg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addBidHistory('âŒ ì…ì°° ìš”ì²­ ì˜¤ë¥˜: ' + error.message);
            });
        }

        // í˜„ì¬ ì…ì°° ì •ë³´ ì—…ë°ì´íŠ¸
        function updateCurrentBid(bidData) {
            console.log('Updating UI with bid data:', bidData);
            if (bidData && bidData.price) {
                document.getElementById('highestBid').textContent = bidData.price.toLocaleString();
                document.getElementById('bidder').textContent = 'User ' + bidData.bidderId;
                document.getElementById('bidTime').textContent = new Date(bidData.createDate).toLocaleTimeString();
            } else {
                console.error('bidData.priceê°€ ì—†ìŠµë‹ˆë‹¤:', bidData);
                addBidHistory('âŒ ì…ì°° ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
            }
        }

        // ì…ì°° ë‚´ì—­ì— ì¶”ê°€
        function addBidHistory(message) {
            const historyDiv = document.getElementById('bidHistory');
            const timestamp = new Date().toLocaleTimeString();
            const newItem = document.createElement('div');
            newItem.className = 'bid-item';
            newItem.innerHTML = '<strong>' + timestamp + '</strong> - ' + message;
            historyDiv.appendChild(newItem);
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('connect').addEventListener('click', connect);
        document.getElementById('disconnect').addEventListener('click', disconnect);
        document.getElementById('subscribe').addEventListener('click', subscribeToProduct);
        document.getElementById('placeBid').addEventListener('click', placeBid);

        // Enter í‚¤ë¡œ ì…ì°°í•˜ê¸°
        document.getElementById('bidAmount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                placeBid();
            }
        });

        // í˜ì´ì§€ ë¡œë“œì‹œ ì•ˆë‚´
        addBidHistory('ğŸ¯ ì‹¤ì‹œê°„ ì…ì°° í…ŒìŠ¤íŠ¸ í˜ì´ì§€ì…ë‹ˆë‹¤.');
        addBidHistory('1. ë¨¼ì € "ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
        addBidHistory('2. ìƒí’ˆ IDë¥¼ ì…ë ¥í•˜ê³  "êµ¬ë…" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
        addBidHistory('3. ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•˜ê³  "ì…ì°°í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
        addBidHistory('4. ë‹¤ë¥¸ íƒ­ì—ì„œë„ ê°™ì€ ìƒí’ˆì„ êµ¬ë…í•˜ë©´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
    </script>
</body>
</html>
