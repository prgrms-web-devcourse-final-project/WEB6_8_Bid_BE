<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ê²½ë§¤ í…ŒìŠ¤íŠ¸ (ê°œì¸ ì•Œë¦¼ ê°•í™”)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .bid-section { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 5px; }
        .current-bid { background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .bid-form { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .bid-history {
            background: #fff; border: 1px solid #eee; padding: 10px;
            height: 300px;
            overflow-y: auto;
        }
        .bid-item { padding: 5px 0; border-bottom: 1px solid #eee; }
        .bid-item:last-child { border-bottom: none; }
        .item-broadcast { color: #0056b3; } /* ì‹¤ì‹œê°„ ë¸Œë¡œë“œìºìŠ¤íŠ¸ (ì „ì²´) */
        .item-personal { color: #8b0000; font-weight: bold; background-color: #ffe0e0; padding: 2px 5px; border-radius: 3px; }
        input, button, select { padding: 8px 12px; margin: 5px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 5px 10px; margin: 5px; border-radius: 3px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ”¥ ì‹¤ì‹œê°„ ê²½ë§¤ í…ŒìŠ¤íŠ¸</h1>

    <div class="bid-section">
        <h3>1ï¸âƒ£ ë¡œê·¸ì¸</h3>
        <select id="userSelect" style="width: 400px;">
            <option value="">ê³„ì • ì„ íƒ...</option>
            <option value="user1@example.com">user1 (ì „ìê¸°ê¸°ì™•) - ì”ì•¡: 500,000ì›</option>
            <option value="user2@example.com">user2 (íŒ¨ì…˜ëŸ¬ë²„) - ì”ì•¡: 1,000,000ì›</option>
            <option value="user3@example.com">user3 (ìŠ¤í¬ì¸ ë§¤ë‹ˆì•„) - ì”ì•¡: 200,000ì›</option>
            <option value="user4@example.com">user4 (ì±…ë²Œë ˆ) - ì”ì•¡: 500,000ì›</option>
            <option value="user5@example.com">user5 (ëª…í’ˆìˆ˜ì§‘ê°€) - ì”ì•¡: 1,000,000ì›</option>
        </select>
        <button id="loginBtn">ë¡œê·¸ì¸</button>
        <p id="loginStatus" style="color: #666; margin: 5px;"></p>
    </div>

    <div class="bid-section">
        <h3>2ï¸âƒ£ WebSocket ì—°ê²°</h3>
        <span id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</span>
        <button id="connect" disabled>ì—°ê²°</button>
        <button id="disconnect" disabled>ì—°ê²° í•´ì œ</button>
        <p><small>ğŸ“¢ ë¡œê·¸ì¸ í›„ WebSocket ì—°ê²°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!</small></p>
    </div>

    <div class="bid-section">
        <h3>3ï¸âƒ£ í…ŒìŠ¤íŠ¸í•  ìƒí’ˆ ì„ íƒ</h3>
        <input type="number" id="productId" placeholder="ìƒí’ˆ ID" value="1">
        <button id="subscribe" disabled>ì´ ìƒí’ˆ ì…ì°° ì •ë³´ ë° ê°œì¸ ì•Œë¦¼ êµ¬ë…</button>
        <p>í˜„ì¬ êµ¬ë… ì¤‘: <span id="currentProduct">ì—†ìŒ</span></p>
    </div>

    <div class="current-bid">
        <h3>ğŸ’° í˜„ì¬ ìµœê³  ì…ì°° (ì „ì²´ ë¸Œë¡œë“œìºìŠ¤íŠ¸)</h3>
        <div id="currentBidInfo">
            <p>ìµœê³ ê°€: <strong id="highestBid">-</strong>ì›</p>
            <p>ì…ì°°ì: <span id="bidder">-</span></p>
            <p>ì‹œê°„: <span id="bidTime">-</span></p>
        </div>
    </div>

    <div class="bid-form">
        <h3>ğŸ¯ ì…ì°°í•˜ê¸° (ê°œì¸ ì•Œë¦¼ í…ŒìŠ¤íŠ¸)</h3>
        <input type="number" id="bidAmount" placeholder="ì…ì°° ê¸ˆì•¡" step="10000" disabled>
        <button id="placeBid" disabled>ì…ì°°í•˜ê¸°</button>
        <p><small>â€» ì…ì°° ì‹œ, ì „ì²´ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë° **ë‚˜ì—ê²Œë§Œ ì˜¤ëŠ” ê°œì¸ ì•Œë¦¼**ì„ í™•ì¸í•˜ì„¸ìš”.</small></p>
    </div>

    <div class="bid-section">
        <h3>ğŸ“Š ì‹¤ì‹œê°„ ë‚´ì—­ (ë¸Œë¡œë“œìºìŠ¤íŠ¸ & ê°œì¸ ì•Œë¦¼)</h3>
        <div id="bidHistory" class="bid-history">
            <p>ë‚´ì—­ì´ ì—¬ê¸°ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤...</p>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentProductId = null;
    let bidSubscription = null;
    let notiSubscription = null;
    let jwtToken = null;

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    async function login() {
        const email = document.getElementById('userSelect').value;
        if (!email) {
            alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
        }

        document.getElementById('loginStatus').textContent = 'ë¡œê·¸ì¸ ì¤‘...';
        
        try {
            const response = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: 'password123'
                })
            });

            if (response.ok) {
                const data = await response.json();
                jwtToken = data.data.accessToken;
                
                document.getElementById('loginStatus').textContent = 'âœ… ë¡œê·¸ì¸ ì„±ê³µ! ' + email;
                document.getElementById('loginStatus').style.color = '#155724';
                document.getElementById('connect').disabled = false;
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('userSelect').disabled = true;
                
                addBidHistory('âœ… ë¡œê·¸ì¸ ì„±ê³µ: ' + email, 'broadcast');
            } else {
                const error = await response.json();
                document.getElementById('loginStatus').textContent = 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.msg;
                document.getElementById('loginStatus').style.color = '#721c24';
            }
        } catch (error) {
            console.error('Login error:', error);
            document.getElementById('loginStatus').textContent = 'âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message;
            document.getElementById('loginStatus').style.color = '#721c24';
        }
    }

    // WebSocket ì—°ê²°
    function connect() {
        if (stompClient && stompClient.connected) return;
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!');
            return;
        }

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        // JWT í† í°ê³¼ í•¨ê»˜ ì—°ê²°
        stompClient.connect({
            'Authorization': 'Bearer ' + jwtToken
        }, function(frame) {
            console.log('Connected: ' + frame);
            document.getElementById('status').textContent = 'ì—°ê²°ë¨';
            document.getElementById('status').className = 'status connected';
            document.getElementById('disconnect').disabled = false;
            document.getElementById('subscribe').disabled = false;
            addBidHistory('âœ… WebSocket ì—°ê²° ì„±ê³µ!', 'broadcast');

            subscribeToNotifications();

        }, function(error) {
            console.log('Connection error: ' + error);
            document.getElementById('status').textContent = 'ì—°ê²° ì‹¤íŒ¨';
            document.getElementById('status').className = 'status disconnected';
            addBidHistory('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error, 'broadcast');
        });
    }

    // WebSocket ì—°ê²° í•´ì œ
    function disconnect() {
        if (stompClient !== null) {
            if (bidSubscription) {
                bidSubscription.unsubscribe();
                bidSubscription = null;
            }
            if (notiSubscription) {
                notiSubscription.unsubscribe();
                notiSubscription = null;
            }
            stompClient.disconnect();
            stompClient = null;

            document.getElementById('status').textContent = 'ì—°ê²° í•´ì œë¨';
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('currentProduct').textContent = 'ì—†ìŒ';
            document.getElementById('disconnect').disabled = true;
            document.getElementById('subscribe').disabled = true;
            document.getElementById('bidAmount').disabled = true;
            document.getElementById('placeBid').disabled = true;
            addBidHistory('ğŸ”Œ WebSocket ì—°ê²° í•´ì œ', 'broadcast');
        }
    }

    // ê°œì¸ ì•Œë¦¼ ì±„ë„ êµ¬ë…
    function subscribeToNotifications() {
        if (notiSubscription) {
            notiSubscription.unsubscribe();
        }

        // '/user/queue/notifications' êµ¬ë…
        notiSubscription = stompClient.subscribe('/user/queue/notifications', function(message) {
            console.log('=== ê°œì¸ ì•Œë¦¼ ìˆ˜ì‹  ===');
            console.log('Notification message:', message.body);

            try {
                const notification = JSON.parse(message.body);
                handlePersonalNotification(notification);
            } catch (error) {
                console.error('ì•Œë¦¼ íŒŒì‹± ì—ëŸ¬:', error);
                addBidHistory('âŒ ê°œì¸ ì•Œë¦¼ íŒŒì‹± ì‹¤íŒ¨: ' + message.body, 'personal');
            }
        });
        addBidHistory('ğŸ”” ê°œì¸ ì•Œë¦¼ ì±„ë„ êµ¬ë… ì„±ê³µ!', 'personal');
    }

    // ìƒí’ˆ êµ¬ë… (ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì±„ë„)
    function subscribeToProduct() {
        const productId = document.getElementById('productId').value;
        if (!productId || !stompClient || !stompClient.connected) {
            alert('ìƒí’ˆ IDë¥¼ ì…ë ¥í•˜ê³  WebSocketì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (bidSubscription) {
            bidSubscription.unsubscribe();
        }

        bidSubscription = stompClient.subscribe('/topic/bid/' + productId, function(message) {
            console.log('=== ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ˜ì‹  ===');
            console.log('Message body:', message.body);

            try {
                const bidData = JSON.parse(message.body);
                handleBroadcastMessage(bidData);
            } catch (error) {
                console.error('JSON íŒŒì‹± ì—ëŸ¬:', error);
                addBidHistory('âŒ ë©”ì‹œì§€ íŒŒì‹± ì‹¤íŒ¨: ' + message.body, 'broadcast');
            }
        });

        currentProductId = productId;
        document.getElementById('currentProduct').textContent = 'ìƒí’ˆ ' + productId;
        document.getElementById('bidAmount').disabled = false;
        document.getElementById('placeBid').disabled = false;
        addBidHistory('ğŸ“¡ ìƒí’ˆ ' + productId + ' ì…ì°° ì •ë³´ êµ¬ë… ì‹œì‘', 'broadcast');
    }

    // ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì‹œì§€ ì²˜ë¦¬ ë¡œì§
    function handleBroadcastMessage(bidData) {

        if (bidData.type === 'BID') {
            // ì…ì°° ì—…ë°ì´íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸
            updateCurrentBid(bidData.data);
            addBidHistory('ğŸš€ ìƒˆ ì…ì°°: ' + bidData.data.price.toLocaleString() + 'ì› (ìƒí’ˆ ' + bidData.data.productId + ')', 'broadcast');
        } else if (bidData.type === 'SYSTEM') {
            // ì‹œìŠ¤í…œ ì•Œë¦¼ (ì¢…ë£Œ ì„ë°•, ì¢…ë£Œ ë“±) ë¸Œë¡œë“œìºìŠ¤íŠ¸
            const content = bidData.content || "ì‹œìŠ¤í…œ ì•Œë¦¼ ë„ì°©";
            addBidHistory('ğŸ“¢ ' + content, 'broadcast');

            if (bidData.data && bidData.data.isSuccessful !== undefined) {
                // ê²½ë§¤ ì¢…ë£Œ ì•Œë¦¼ ìƒì„¸ (ë‚™ì°°/ìœ ì°°)
                if (bidData.data.isSuccessful) {
                    addBidHistory('ğŸ‰ ë‚™ì°°! ìµœì¢… ë‚™ì°°ê°€: ' + bidData.data.finalPrice.toLocaleString() + 'ì›', 'broadcast');
                } else {
                    addBidHistory('ğŸ˜” ìœ ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'broadcast');
                }
            }
        }
    }

    // ê°œì¸ ì•Œë¦¼ ë©”ì‹œì§€ ì²˜ë¦¬ ë¡œì§ (Auction/BidNotificationServiceì—ì„œ ì˜¤ëŠ” ì•Œë¦¼)
    function handlePersonalNotification(notification) {
        const content = notification.content;
        const data = notification.data;

        // ë©”ì¸ ì•Œë¦¼ ë¡œê·¸ ì¶œë ¥
        addBidHistory(`ğŸ”” ${content}`, 'personal');

        if (data && data.type) {
            let detailMessage = '';

            switch(data.type) {
                case 'AUCTION_START': // AuctionNotificationService
                    detailMessage = `â–¶ï¸ ê²½ë§¤ ì‹œì‘! ì‹œì‘ê°€: ${data.initialPrice.toLocaleString()}ì›`;
                    break;
                case 'AUCTION_ENDING_SOON': // AuctionNotificationService
                    detailMessage = `â³ ì¢…ë£Œ ì„ë°•! ${data.remainingMinutes}ë¶„ í›„ ì¢…ë£Œ. í˜„ì¬ê°€: ${data.currentPrice.toLocaleString()}ì›`;
                    break;
                case 'AUCTION_END': // AuctionNotificationService
                    detailMessage = data.hasWinner ?
                        `ğŸ† ê²½ë§¤ ì¢…ë£Œ: ìµœì¢…ê°€ ${data.finalPrice.toLocaleString()}ì›` :
                        `ğŸ’§ ê²½ë§¤ ì¢…ë£Œ: ìœ ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    break;
                case 'BID_SUCCESS': // BidNotificationService
                    detailMessage = `âœ… ë‚˜ì˜ ì…ì°° ì„±ê³µ: ${data.bidAmount.toLocaleString()}ì› (ìµœê³ ê°€ ìœ ì§€)`;
                    break;
                case 'BID_OUTBID': // BidNotificationService
                    detailMessage = `ğŸ˜” ì…ì°° ë°€ë¦¼! ìƒˆë¡œìš´ ìµœê³ ê°€: ${data.newHighestBid.toLocaleString()}ì›`;
                    break;
                case 'AUCTION_WON': // BidNotificationService
                    detailMessage = `ğŸ‰ **ìµœì¢… ë‚™ì°° ì„±ê³µ!** ê¸ˆì•¡: ${data.finalPrice.toLocaleString()}ì›`;
                    break;
                case 'AUCTION_LOST': // BidNotificationService
                    detailMessage = `ğŸ˜ **ë‚™ì°° ì‹¤íŒ¨**. ìµœì¢…ê°€: ${data.finalPrice.toLocaleString()}ì›`;
                    break;
                default:
                    detailMessage = `âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ì•Œë¦¼ íƒ€ì…: ${data.type}`;
                    break;
            }

            if (detailMessage) {
                // ìƒì„¸ ì •ë³´ëŠ” ê°™ì€ ìœ í˜•ìœ¼ë¡œ í•œë²ˆ ë” ì¶œë ¥í•˜ì—¬ ê°•ì¡°
                addBidHistory(detailMessage, 'personal');
            }
        }
    }

    // REST APIë¡œ ì…ì°°í•˜ê¸°
    async function placeBid() {
        const productId = document.getElementById('productId').value;
        const bidAmount = document.getElementById('bidAmount').value;

        if (!productId || !bidAmount) {
            alert('ìƒí’ˆ IDì™€ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!');
            return;
        }

        try {
            const response = await fetch('/api/v1/bids/products/' + productId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify({
                    price: parseInt(bidAmount)
                })
            });

            if (response.ok) {
                addBidHistory('âœ… ì…ì°° ìš”ì²­ ì „ì†¡: ' + parseInt(bidAmount).toLocaleString() + 'ì›', 'broadcast');
                document.getElementById('bidAmount').value = '';
            } else {
                const data = await response.json();
                addBidHistory('âŒ ì…ì°° ìš”ì²­ ì‹¤íŒ¨: ' + (data.msg || data.message), 'broadcast');
            }
        } catch (error) {
            console.error('Error:', error);
            addBidHistory('âŒ ì…ì°° ìš”ì²­ ì˜¤ë¥˜: ' + error.message, 'broadcast');
        }
    }

    // í˜„ì¬ ì…ì°° ì •ë³´ ì—…ë°ì´íŠ¸
    function updateCurrentBid(bidData) {
        if (bidData && bidData.price) {
            document.getElementById('highestBid').textContent = bidData.price.toLocaleString();
            // ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë°ì´í„°ì— bidderIdê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
            document.getElementById('bidder').textContent = 'User ' + (bidData.bidderId || '?');
            document.getElementById('bidTime').textContent = new Date(bidData.createDate).toLocaleTimeString();
        }
    }

    // ì…ì°° ë‚´ì—­ì— ì¶”ê°€ (ê°œì¸ ì•Œë¦¼ê³¼ ì „ì²´ ì•Œë¦¼ì„ êµ¬ë¶„)
    function addBidHistory(message, type = 'broadcast') {
        const historyDiv = document.getElementById('bidHistory');
        const timestamp = new Date().toLocaleTimeString();
        const newItem = document.createElement('div');
        newItem.className = 'bid-item';

        let typeClass = '';
        if (type === 'personal') {
            typeClass = 'item-personal';
        } else if (type === 'broadcast') {
            typeClass = 'item-broadcast';
        }

        newItem.innerHTML = `<span class="${typeClass}">[${type === 'personal' ? 'ê°œì¸' : 'ì „ì²´'}]</span> <strong>${timestamp}</strong> - ${message}`;

        historyDiv.appendChild(newItem);
        historyDiv.scrollTop = historyDiv.scrollHeight;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('connect').addEventListener('click', connect);
    document.getElementById('disconnect').addEventListener('click', disconnect);
    document.getElementById('subscribe').addEventListener('click', subscribeToProduct);
    document.getElementById('placeBid').addEventListener('click', placeBid);

    // Enter í‚¤ë¡œ ì…ì°°í•˜ê¸°
    document.getElementById('bidAmount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            placeBid();
        }
    });

    // í˜ì´ì§€ ë¡œë“œì‹œ ì•ˆë‚´
    addBidHistory('ğŸ¯ ì‹¤ì‹œê°„ ê²½ë§¤ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ì…ë‹ˆë‹¤.', 'broadcast');
    addBidHistory('1. ê³„ì •ì„ ì„ íƒí•˜ê³  "ë¡œê·¸ì¸" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'broadcast');
    addBidHistory('2. "ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ WebSocketì„ ì—°ê²°í•˜ì„¸ìš”.', 'broadcast');
    addBidHistory('3. ìƒí’ˆ IDë¥¼ ì…ë ¥í•˜ê³  "êµ¬ë…" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'broadcast');
    addBidHistory('4. ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•˜ê³  "ì…ì°°í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê°œì¸ ì•Œë¦¼ì„ í™•ì¸í•˜ì„¸ìš”.', 'broadcast');
    addBidHistory('ğŸ’¡ ì°½ 2ê°œë¥¼ ì—´ì–´ì„œ ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!', 'broadcast');
</script>
</body>
</html>