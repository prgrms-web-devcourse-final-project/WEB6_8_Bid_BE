version: "3.8"

services:
  # ê¸°ë³¸ k6 ì„œë¹„ìŠ¤
  k6:
    image: grafana/k6:latest
    container_name: k6-load-test
    working_dir: /scripts
    volumes:
      - ./:/scripts
      - ./results:/results
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - BASE_URL=http://host.docker.internal:8080
      - PRODUCT_ID=${PRODUCT_ID:-1}
      - BASE_PRICE=${BASE_PRICE:-1000000}
      - PRICE_INCREMENT=${PRICE_INCREMENT:-100}
      - USE_AUTH=${USE_AUTH:-false}
      - DETAILED_LOG=${DETAILED_LOG:-false}
    command: run ${TEST_SCRIPT:-bid-concurrent-test.js}

  # 1000ëª… ë™ì‹œ ì…ì°° í…ŒìŠ¤íŠ¸ ì „ìš©
  bid-test:
    image: grafana/k6:latest
    container_name: k6-bid-test
    working_dir: /scripts
    volumes:
      - ./:/scripts
      - ./results:/results
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - BASE_URL=http://host.docker.internal:8080
      - PRODUCT_ID=${PRODUCT_ID:-1}
      - BASE_PRICE=${BASE_PRICE:-1000000}
      - PRICE_INCREMENT=${PRICE_INCREMENT:-100}
      - USE_AUTH=${USE_AUTH:-false}
      - DETAILED_LOG=${DETAILED_LOG:-false}
    command: run bid-concurrent-test.js

  # ìƒí’ˆ ì¡°íšŒ í…ŒìŠ¤íŠ¸
  product-test:
    image: grafana/k6:latest
    container_name: k6-product-test
    working_dir: /scripts
    volumes:
      - ./:/scripts
      - ./results:/results
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: run getProducts-test.js

  # Elasticsearch ê²€ìƒ‰ í…ŒìŠ¤íŠ¸
  search-test:
    image: grafana/k6:latest
    container_name: k6-search-test
    working_dir: /scripts
    volumes:
      - ./:/scripts
      - ./results:/results
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: run getProductsByElasticsearch-test.js

  # ëª¨ë“  í…ŒìŠ¤íŠ¸ ìˆœì°¨ ì‹¤í–‰
  all-tests:
    image: grafana/k6:latest
    container_name: k6-all-tests
    working_dir: /scripts
    volumes:
      - ./:/scripts
      - ./results:/results
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: /bin/sh
    command: |
      -c "
      echo 'ğŸ Starting all performance tests...'
      echo '================================='
      echo '1/3 Running bid concurrent test...'
      k6 run bid-concurrent-test.js
      echo '================================='
      echo '2/3 Running products API test...'
      k6 run getProducts-test.js  
      echo '================================='
      echo '3/3 Running Elasticsearch test...'
      k6 run getProductsByElasticsearch-test.js
      echo '================================='
      echo 'âœ… All tests completed!'
      "

# ê²°ê³¼ ì €ì¥ìš© ë³¼ë¥¨
volumes:
  results:
